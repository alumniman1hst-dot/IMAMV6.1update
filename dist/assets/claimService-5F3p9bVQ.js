import{i as o,d as s,c as i,U as w}from"./index-CcQVG4nr.js";/**
 * @license
 * IMAM System - Integrated Madrasah Academic Manager
 */const c="claim_requests",g=t=>{if(!t)return"";let e=t.replace(/\b(Drs|Dra|Hj|H|Prof|Dr|Ir|Ustadz|Kiai)\.?\s+/gi,"");return e=e.replace(/,\s?([A-Z][a-z]?\.?)+(\s?[A-Z][a-z]?\.?)*/g,""),e=e.replace(/[.,]/g,""),e.trim().toLowerCase()},y=async(t,e,r)=>{var l;if(o)return console.log("Mock kirim klaim:",t,e,r),new Promise(u=>setTimeout(u,1e3));if(!s||!((l=i)!=null&&l.currentUser))throw new Error("Akses ditolak. Sesi tidak aktif.");const n=i.currentUser.uid;if(!(await s.collection(c).where("userId","==",n).where("status","in",["pending","reviewing"]).get()).empty)throw new Error("Anda masih memiliki pengajuan aktif yang sedang diproses.");const d={userId:n,userName:i.currentUser.displayName||"User",userEmail:i.currentUser.email||"",type:t,targetId:e.trim(),secondaryId:r.trim(),status:"pending",createdAt:new Date().toISOString()};try{const u=t==="siswa"?"students":"teachers",p=await s.collection(u).doc(e.trim()).get();if(p.exists){const a=p.data(),f=(a==null?void 0:a.namaLengkap)||(a==null?void 0:a.name)||"";if(t==="guru"){const U=g(r),A=g(f);U===A&&(d.autoMatch=!0)}else((a==null?void 0:a.idUnik)===r.trim()||(a==null?void 0:a.nisn)===r.trim())&&(d.autoMatch=!0)}}catch(u){console.warn("Auto-match check failed",u)}await s.collection(c).add(d)},I=async t=>{if(o)return[];if(!s)return[];let e=s.collection(c).orderBy("createdAt","desc");return t!=="all"&&(e=e.where("status","==",t)),(await e.get()).docs.map(n=>({id:n.id,...n.data()}))},k=async t=>{var e;o||!s||!((e=i)!=null&&e.currentUser)||await s.collection(c).doc(t).update({status:"reviewing",processedBy:i.currentUser.displayName||"Admin",processedAt:new Date().toISOString()})},S=async t=>{var l;if(o||!s||!((l=i)!=null&&l.currentUser))return;const e=s.batch(),r=s.collection(c).doc(t.id),n=s.collection("users").doc(t.userId);e.update(r,{status:"approved",processedAt:new Date().toISOString(),processedBy:i.currentUser.displayName||"Admin"});const m=t.type==="siswa"?w.SISWA:w.GURU,d=t.type==="siswa"?"students":"teachers";e.update(n,{role:m,idUnik:t.targetId,claimVerified:!0,[t.type==="siswa"?"studentId":"teacherId"]:t.targetId}),e.update(s.collection(d).doc(t.targetId),{accountStatus:"Active",linkedUserId:t.userId,isClaimed:!0,updatedAt:new Date().toISOString()}),await e.commit()},C=async(t,e)=>{var r;o||!s||!((r=i)!=null&&r.currentUser)||await s.collection(c).doc(t).update({status:"rejected",adminReason:e,processedAt:new Date().toISOString(),processedBy:i.currentUser.displayName||"Admin"})},N=async()=>{var e;return o||!s||!((e=i)!=null&&e.currentUser)?[]:(await s.collection(c).where("userId","==",i.currentUser.uid).orderBy("createdAt","desc").get()).docs.map(r=>({id:r.id,...r.data()}))};export{I as a,k as b,g as c,S as d,N as g,C as r,y as s};
