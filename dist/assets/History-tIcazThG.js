import{r as h,j as a,m as w,a as B,c as k,i as T,d as b,H as O,ap as U,E as C,C as L,X as R,U as g}from"./index-CcQVG4nr.js";import{L as K}from"./Layout-aA6jRwwe.js";const V=({onBack:v,userRole:o})=>{const[p,N]=h.useState([]),[A,x]=h.useState(!0),[m,H]=h.useState("all"),M=t=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(t);h.useEffect(()=>{(async()=>{var l,S;x(!0);const n=((S=(l=k)==null?void 0:l.currentUser)==null?void 0:S.uid)||(T?"user-1":""),u=o===g.ADMIN||o===g.STAF_TU||o===g.KEPALA_MADRASAH||o===g.GURU,r=[];if(T){setTimeout(()=>{r.push({id:"pay-1",type:"payment",date:new Date().toISOString(),title:"SPP Bulan Mei",subtitle:"Pembayaran Via Transfer",status:"success",amount:"Rp 150.000"},{id:"pay-2",type:"payment",date:new Date(Date.now()-1296e6).toISOString(),title:"Uang Seragam",subtitle:"Cicilan 1",status:"success",amount:"Rp 300.000"}),r.push({id:"att-1",type:"attendance",date:new Date().toISOString(),title:"Absensi Masuk",subtitle:"07:15 - Tepat Waktu",status:"success"},{id:"att-h",type:"haid",date:new Date().toISOString(),title:"Ibadah (Mode Haid)",subtitle:"Pencatatan Khusus Siswi",status:"haid"},{id:"att-2",type:"attendance",date:new Date(Date.now()-864e5).toISOString(),title:"Absensi Pulang",subtitle:"16:00 - Selesai",status:"success"}),r.push({id:"let-1",type:"letter",date:new Date(Date.now()-1728e5).toISOString(),title:"Surat Keterangan Aktif",subtitle:"Menunggu Persetujuan",status:"pending"}),N(r.sort((d,f)=>new Date(f.date).getTime()-new Date(d.date).getTime())),x(!1)},800);return}if(!b){x(!1);return}try{const d=[];let f=b.collection("attendance").orderBy("date","desc").limit(20);d.push(f.get().then(c=>{c.docs.forEach(i=>{const e=i.data();if(!u&&e.studentId!==n&&e.userId!==n)return;const s=e.status==="Haid";r.push({id:i.id,type:s?"haid":"attendance",date:e.date+(e.checkIn?"T"+e.checkIn:""),title:s?`Ibadah: ${e.studentName||"Siswa"} (Haid)`:e.status==="Hadir"?`Hadir: ${e.studentName||"Siswa"}`:`${e.status}: ${e.studentName}`,subtitle:s?"Tercatat dalam Mode Haid":e.checkIn?`Masuk Pukul ${e.checkIn.substring(0,5)}`:"Tidak ada data jam",status:s?"haid":e.status==="Hadir"?"success":e.status==="Terlambat"?"warning":"error"})})}));let y=b.collection("letters").orderBy("date","desc").limit(20);u||(y=y.where("userId","==",n)),d.push(y.get().then(c=>{c.docs.forEach(i=>{const e=i.data();let s="pending";e.status==="Signed"||e.status==="Selesai"?s="success":e.status==="Ditolak"?s="error":(e.status==="Verified"||e.status==="Validated"||e.status==="Diproses")&&(s="warning"),r.push({id:i.id,type:"letter",date:e.date,title:e.type,subtitle:`${e.userName} â€¢ ${e.status}`,status:s})})}));let E=b.collection("payments").limit(20);d.push(E.get().then(c=>{c.docs.forEach(i=>{var I,D;const e=i.data();if(!u&&((D=(I=k)==null?void 0:I.currentUser)!=null&&D.displayName)&&e.studentName!==k.currentUser.displayName)return;let s="success";(e.status==="Belum Lunas"||e.status==="Pending")&&(s="warning"),e.status==="Gagal"&&(s="error"),r.push({id:i.id,type:"payment",date:e.date||new Date().toISOString(),title:`${e.type} (${e.month||"-"})`,subtitle:e.studentName,status:s,amount:e.amount?M(e.amount):"Rp 0"})})})),await Promise.all(d),r.sort((c,i)=>{const e=new Date(c.date).getTime()||0;return(new Date(i.date).getTime()||0)-e}),N(r)}catch(d){console.error("Error fetching history:",d)}finally{x(!1)}})()},[o]);const j=h.useMemo(()=>m==="all"?p:m==="attendance"?p.filter(t=>t.type==="attendance"||t.type==="haid"):p.filter(t=>t.type===m),[p,m]),P=(t,n)=>n==="haid"||t==="haid"?a.jsx(O,{className:"w-5 h-5 text-rose-600 fill-current"}):t==="payment"?a.jsx(U,{className:"w-5 h-5 text-emerald-600"}):t==="letter"?a.jsx(C,{className:"w-5 h-5 text-blue-600"}):n==="success"?a.jsx(L,{className:"w-5 h-5 text-teal-600"}):n==="warning"?a.jsx(w,{className:"w-5 h-5 text-orange-600"}):a.jsx(R,{className:"w-5 h-5 text-red-600"}),$=(t,n)=>n==="haid"||t==="haid"?"bg-rose-50 dark:bg-rose-900/20":t==="payment"?"bg-emerald-50 dark:bg-emerald-900/20":t==="letter"?"bg-blue-50 dark:bg-blue-900/20":n==="success"?"bg-teal-50 dark:bg-teal-900/20":n==="warning"?"bg-orange-50 dark:bg-orange-900/20":"bg-red-50 dark:bg-red-900/20";return a.jsx(K,{title:"Riwayat Transaksi",subtitle:"Kehadiran, Surat & Pembayaran",icon:w,onBack:v,children:a.jsxs("div",{className:"p-4 lg:p-6 pb-24",children:[a.jsx("div",{className:"flex gap-2 overflow-x-auto pb-2 mb-4 scrollbar-hide",children:[{id:"all",label:"Semua"},{id:"attendance",label:"Kehadiran"},{id:"payment",label:"Pembayaran"},{id:"letter",label:"Surat & Izin"}].map(t=>a.jsx("button",{onClick:()=>H(t.id),className:`px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap transition-all border ${m===t.id?"bg-slate-800 text-white border-slate-800 dark:bg-white dark:text-slate-900":"bg-white dark:bg-slate-800 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-700 hover:bg-slate-50"}`,children:t.label},t.id))}),A?a.jsxs("div",{className:"flex flex-col items-center justify-center py-20 text-slate-400",children:[a.jsx(B,{className:"w-8 h-8 animate-spin mb-3"}),a.jsx("p",{className:"text-sm",children:"Memuat data riwayat..."})]}):j.length>0?a.jsx("div",{className:"space-y-4",children:j.map((t,n)=>{let u="-",r="";try{const l=new Date(t.date);isNaN(l.getTime())||(u=l.toLocaleDateString("id-ID",{day:"numeric",month:"short",year:"numeric"}),(t.date.includes("T")||t.date.includes(":"))&&(r=l.toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"})))}catch{}return a.jsxs("div",{className:"bg-white dark:bg-slate-800 p-4 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm flex items-center gap-4 hover:shadow-md transition-shadow",children:[a.jsx("div",{className:`w-12 h-12 rounded-2xl flex items-center justify-center shrink-0 ${$(t.type,t.status)}`,children:P(t.type,t.status)}),a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsxs("div",{className:"flex justify-between items-start",children:[a.jsx("h4",{className:"font-bold text-slate-800 dark:text-white text-sm line-clamp-1 uppercase tracking-tight",children:t.title}),a.jsx("span",{className:"text-[10px] text-slate-400 font-medium whitespace-nowrap ml-2",children:u})]}),a.jsxs("div",{className:"flex justify-between items-end mt-0.5",children:[a.jsx("p",{className:"text-xs text-slate-500 dark:text-slate-400 line-clamp-1 font-medium",children:t.subtitle}),r&&(t.type==="attendance"||t.type==="haid")&&a.jsx("span",{className:"text-[10px] font-mono text-slate-400",children:r})]}),t.amount&&a.jsx("div",{className:"mt-2 inline-flex items-center gap-1 bg-emerald-50 dark:bg-emerald-900/10 px-2 py-0.5 rounded text-[10px] font-bold text-emerald-600 dark:text-emerald-400 border border-emerald-100 dark:border-emerald-900/20",children:t.amount})]})]},t.id)})}):a.jsxs("div",{className:"text-center py-20 bg-white dark:bg-slate-800 rounded-3xl border border-dashed border-slate-200 dark:border-slate-700",children:[a.jsx("div",{className:"w-12 h-12 bg-slate-100 dark:bg-slate-700 rounded-full flex items-center justify-center mx-auto mb-3 text-slate-400",children:a.jsx(w,{className:"w-6 h-6"})}),a.jsx("p",{className:"text-slate-500 dark:text-slate-400 text-sm font-bold uppercase tracking-widest",children:"Belum ada riwayat tercatat."})]})]})})};export{V as default};
