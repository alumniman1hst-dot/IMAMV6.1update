import{i as j,U as l,d as h,r as c,c as A,j as e,E as R,a as te,al as M,e as ae,b as se,a5 as $,X as G,p as re,S as W,x as le,P as ne,T as ie,C as F,m as de,t as u}from"./index-CcQVG4nr.js";import{L as oe}from"./Layout-aA6jRwwe.js";import{Q as ce}from"./index-DPVcr-rT.js";const E="letters",N=[{id:"req-1",userId:"user-1",userName:"Ahmad Dahlan",userRole:l.SISWA,type:"Surat Keterangan Aktif",description:"Untuk keperluan beasiswa prestasi.",date:new Date(Date.now()-864e5).toISOString(),status:"Signed",letterNumber:"421/105/MAN1HST/2024"},{id:"req-2",userId:"user-2",userName:"Siti Aminah",userRole:l.GURU,type:"Surat Tugas",description:"Menghadiri MGMP Matematika di Kandangan.",date:new Date().toISOString(),status:"Pending"},{id:"req-3",userId:"user-3",userName:"Budi Santoso",userRole:l.SISWA,type:"Legalisir Ijazah",description:"Mohon legalisir 5 rangkap.",date:new Date(Date.now()-1728e5).toISOString(),status:"Verified"}],xe=async i=>{if(j)return console.log("Mock create letter:",i),N.unshift({...i,id:`req-${Date.now()}`}),new Promise(r=>setTimeout(r,800));try{if(!h)throw new Error("Database not initialized");await h.collection(E).add(i)}catch(r){throw console.error("Error creating letter:",r),r}},ue=async(i,r,d)=>{if(j){console.log("Mock update status:",i,r,d);const g=N.findIndex(p=>p.id===i);return g!==-1&&(N[g]={...N[g],status:r,...d}),new Promise(p=>setTimeout(p,500))}try{if(!h)throw new Error("Database not initialized");await h.collection(E).doc(i).update({status:r,...d})}catch(g){throw console.error("Error updating letter:",g),g}},ge=async i=>{if(j){const r=N.findIndex(d=>d.id===i);return r!==-1&&N.splice(r,1),new Promise(d=>setTimeout(d,500))}try{if(!h)throw new Error("Database not initialized");await h.collection(E).doc(i).delete()}catch(r){throw console.error("Error deleting letter:",r),r}},pe=({onBack:i,userRole:r})=>{const[d,g]=c.useState([]),[p,w]=c.useState(!0),[S,_]=c.useState("All"),[L,b]=c.useState(!1),[y,U]=c.useState("create"),[a,q]=c.useState(null),[f,I]=c.useState({type:"Surat Keterangan Aktif",description:""}),[H,Q]=c.useState(""),[D,B]=c.useState(""),X=[l.SISWA,l.GURU,l.ORANG_TUA,l.STAF_TU,l.WALI_KELAS,l.KETUA_KELAS].includes(r),T=r===l.STAF_TU||r===l.ADMIN||r===l.DEVELOPER,P=r===l.ADMIN||r===l.DEVELOPER,V=r===l.KEPALA_MADRASAH||r===l.DEVELOPER,C=T||P||V;c.useEffect(()=>{var n;if(w(!0),j){setTimeout(()=>{g([{id:"1",userId:"mock",userName:"Ahmad Dahlan",userRole:l.SISWA,type:"Surat Keterangan Aktif",description:"Untuk persyaratan beasiswa prestasi daerah.",date:new Date().toISOString(),status:"Verified",letterNumber:"421/105/MAN1/2024",verifiedBy:"Staf TU",verifiedAt:new Date().toISOString()}]),w(!1)},500);return}if(!h){w(!1);return}let t=h.collection("letters").orderBy("date","desc");!C&&((n=A)!=null&&n.currentUser)&&(t=t.where("userId","==",A.currentUser.uid));const o=t.onSnapshot(s=>{const x=s.docs.map(m=>({id:m.id,...m.data()}));g(x),w(!1)},s=>{console.error("Error fetching letters:",s),w(!1)});return()=>o()},[C]);const O=c.useMemo(()=>S==="All"?d:d.filter(t=>t.status===S),[d,S]),K=()=>{I({type:"Surat Keterangan Aktif",description:""}),U("create"),b(!0)},J=t=>{q(t),Q(t.adminNote||""),B(t.letterNumber||""),U("detail"),b(!0)},z=async t=>{var n;if(t.preventDefault(),!f.description){u.error("Mohon isi keterangan keperluan.");return}const o=u.loading("Mengirim permohonan...");try{const s=(n=A)==null?void 0:n.currentUser,x=(s==null?void 0:s.displayName)||(j?"User Simulasi":"Pengguna"),m=(s==null?void 0:s.uid)||(j?"user-1":"unknown");await xe({userId:m,userName:x,userRole:r,type:f.type,description:f.description,date:new Date().toISOString(),status:"Pending"}),u.success("Permohonan berhasil dikirim!",{id:o}),b(!1)}catch(s){console.error(s),u.error("Gagal mengirim permohonan.",{id:o})}},k=async t=>{var n;if(!a)return;if(t==="Verified"&&!D){u.error("Nomor surat wajib diisi oleh Tata Usaha.");return}const o=u.loading("Memperbarui status surat...");try{const s={status:t,adminNote:H},x=(n=A)==null?void 0:n.currentUser,m=(x==null?void 0:x.displayName)||"System";t==="Verified"?(s.letterNumber=D,s.verifiedBy=m,s.verifiedAt=new Date().toISOString()):t==="Validated"?(s.validatedBy=m,s.validatedAt=new Date().toISOString()):t==="Signed"&&(s.signedBy=m,s.signedAt=new Date().toISOString(),s.digitalSignatureHash=`SIGNED-${a.id}-${Date.now()}`),await ue(a.id,t,s),u.success(`Status berhasil diubah: ${t}`,{id:o}),b(!1)}catch{u.error("Gagal memperbarui status.",{id:o})}},Y=async t=>{if(window.confirm("Hapus permohonan ini?"))try{await ge(t),u.success("Permohonan dihapus."),L&&b(!1)}catch{u.error("Gagal menghapus.")}},Z=t=>{switch(t){case"Pending":return"bg-slate-100 text-slate-600 dark:bg-slate-800 dark:text-slate-400";case"Verified":return"bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400";case"Validated":return"bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400";case"Signed":return"bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400";case"Ditolak":return"bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400";default:return"bg-slate-100 text-slate-700"}},ee=t=>{switch(t){case"Pending":return e.jsx(de,{className:"w-3.5 h-3.5"});case"Verified":return e.jsx(M,{className:"w-3.5 h-3.5"});case"Validated":return e.jsx(W,{className:"w-3.5 h-3.5"});case"Signed":return e.jsx(F,{className:"w-3.5 h-3.5"});case"Ditolak":return e.jsx(G,{className:"w-3.5 h-3.5"})}},v=({label:t,active:o,completed:n,date:s,actor:x})=>e.jsxs("div",{className:"flex gap-4 min-h-[60px]",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center border-2 z-10 ${n?"bg-indigo-600 border-indigo-600 text-white":o?"bg-white border-indigo-600 text-indigo-600 animate-pulse":"bg-slate-50 border-slate-200 text-slate-300"}`,children:n?e.jsx(F,{className:"w-4 h-4"}):e.jsx("div",{className:"w-2 h-2 rounded-full bg-current"})}),e.jsx("div",{className:`w-0.5 flex-1 ${n?"bg-indigo-600":"bg-slate-200"} my-1`})]}),e.jsxs("div",{className:`pb-6 ${n||o?"opacity-100":"opacity-50"}`,children:[e.jsx("p",{className:"text-xs font-bold uppercase tracking-wider",children:t}),n&&x&&e.jsxs("p",{className:"text-[10px] text-slate-500",children:["Oleh: ",x]}),n&&s&&e.jsxs("p",{className:"text-[9px] text-slate-400",children:[new Date(s).toLocaleDateString()," ",new Date(s).toLocaleTimeString().slice(0,5)]})]})]});return e.jsx(oe,{title:"Layanan Surat",subtitle:"Sistem Terpadu PTSP",icon:R,onBack:i,actions:e.jsxs("button",{onClick:K,disabled:p,className:`px-4 py-2.5 rounded-xl text-xs font-bold flex items-center gap-2 transition-all ${p?"bg-slate-100 text-slate-300":"bg-indigo-600 text-white shadow-lg shadow-indigo-200 dark:shadow-none hover:bg-indigo-700"}`,children:[e.jsx($,{className:"w-4 h-4"})," Ajukan"]}),children:e.jsxs("div",{className:"p-4 lg:p-6 pb-24 space-y-6",children:[e.jsx("div",{className:"flex gap-2 overflow-x-auto pb-2 scrollbar-hide",children:["All","Pending","Verified","Validated","Signed","Ditolak"].map(t=>e.jsx("button",{onClick:()=>_(t),className:`px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap transition-all border ${S===t?"bg-slate-800 text-white border-slate-800 dark:bg-white dark:text-slate-900":"bg-white dark:bg-slate-800 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-700 hover:bg-slate-50"}`,children:t==="All"?"Semua":t==="Signed"?"Selesai":t},t))}),p?e.jsxs("div",{className:"flex flex-col items-center justify-center py-20 text-slate-400 gap-3",children:[e.jsx(te,{className:"w-8 h-8 animate-spin text-indigo-500 opacity-20"}),e.jsx("p",{className:"text-[10px] font-black uppercase tracking-widest",children:"Sinkronisasi PTSP..."})]}):O.length>0?e.jsx("div",{className:"grid grid-cols-1 gap-3",children:O.map(t=>e.jsxs("div",{onClick:()=>J(t),className:"bg-white dark:bg-slate-800 p-4 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm hover:shadow-md transition-all cursor-pointer group active:scale-[0.99]",children:[e.jsxs("div",{className:"flex justify-between items-start mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center ${t.type.includes("Keterangan")?"bg-blue-50 text-blue-600 dark:bg-blue-900/20 dark:text-blue-400":t.type.includes("Izin")?"bg-orange-50 text-orange-600 dark:bg-orange-900/20 dark:text-orange-400":"bg-purple-50 text-purple-600 dark:bg-purple-900/20 dark:text-purple-400"}`,children:e.jsx(M,{className:"w-5 h-5"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-slate-800 dark:text-white text-sm",children:t.type}),e.jsx("p",{className:"text-xs text-slate-500 dark:text-slate-400 line-clamp-1",children:t.description})]})]}),e.jsxs("span",{className:`px-2.5 py-1 rounded-lg text-[10px] font-bold uppercase flex items-center gap-1 ${Z(t.status)}`,children:[ee(t.status),t.status==="Signed"?"Selesai":t.status]})]}),e.jsxs("div",{className:"flex items-center justify-between pt-3 border-t border-slate-50 dark:border-slate-700/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[C&&e.jsxs("div",{className:"flex items-center gap-1.5 bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded-lg",children:[e.jsx(ae,{className:"w-3 h-3 text-slate-400"}),e.jsx("span",{className:"text-[10px] font-bold text-slate-600 dark:text-slate-300",children:t.userName}),e.jsxs("span",{className:"text-[9px] text-slate-400",children:["(",t.userRole,")"]})]}),e.jsx("span",{className:"text-[10px] text-slate-400",children:new Date(t.date).toLocaleDateString("id-ID",{day:"numeric",month:"short",year:"numeric"})})]}),e.jsx(se,{className:"w-4 h-4 text-slate-300 group-hover:text-indigo-500 transition-colors"})]})]},t.id))}):e.jsxs("div",{className:"text-center py-16 bg-white dark:bg-slate-800 rounded-3xl border border-dashed border-slate-200 dark:border-slate-700",children:[e.jsx(R,{className:"w-12 h-12 text-slate-300 dark:text-slate-600 mx-auto mb-3"}),e.jsx("p",{className:"text-slate-500 dark:text-slate-400 text-sm",children:"Belum ada permohonan surat."}),e.jsx("button",{onClick:K,className:"mt-4 text-indigo-600 font-bold text-xs hover:underline",children:"Buat Permohonan Baru"})]}),L&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm",children:e.jsxs("div",{className:"bg-white dark:bg-slate-900 w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden animate-in zoom-in duration-200 flex flex-col max-h-[90vh]",children:[e.jsxs("div",{className:"p-5 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-white dark:bg-slate-900 z-10",children:[e.jsxs("h3",{className:"font-bold text-lg text-slate-800 dark:text-white flex items-center gap-2",children:[y==="create"?e.jsx($,{className:"w-5 h-5 text-indigo-500"}):e.jsx(M,{className:"w-5 h-5 text-indigo-500"}),y==="create"?"Buat Permohonan":"Detail Surat"]}),e.jsx("button",{onClick:()=>b(!1),className:"p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full text-slate-400 hover:text-slate-600",children:e.jsx(G,{className:"w-6 h-6"})})]}),e.jsx("div",{className:"p-6 overflow-y-auto",children:y==="create"?e.jsxs("form",{id:"createForm",onSubmit:z,className:"space-y-5",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-bold text-slate-500 uppercase block mb-2",children:"Jenis Surat"}),e.jsxs("select",{value:f.type,onChange:t=>I({...f,type:t.target.value}),className:"w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none",children:[e.jsx("option",{children:"Surat Keterangan Aktif Siswa"}),e.jsx("option",{children:"Surat Izin Penelitian"}),e.jsx("option",{children:"Surat Permohonan Pindah/Mutasi"}),e.jsx("option",{children:"Surat Tugas Guru"}),e.jsx("option",{children:"Surat Cuti Pegawai"}),e.jsx("option",{children:"Legalisir Ijazah/Rapor"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-bold text-slate-500 uppercase block mb-2",children:"Keperluan / Keterangan"}),e.jsx("textarea",{rows:4,value:f.description,onChange:t=>I({...f,description:t.target.value}),className:"w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none resize-none",placeholder:"Contoh: Untuk persyaratan administrasi beasiswa..."})]})]}):a?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-slate-800 dark:text-white text-base",children:a.type}),e.jsx("p",{className:"text-sm text-slate-500 dark:text-slate-400 mt-1",children:a.description}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx("span",{className:"text-[10px] bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded text-slate-500",children:new Date(a.date).toLocaleDateString()}),a.letterNumber&&e.jsx("span",{className:"text-[10px] bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 px-2 py-1 rounded font-mono font-bold border border-indigo-100 dark:border-indigo-800",children:a.letterNumber})]})]}),a.status==="Signed"&&e.jsx("div",{className:"bg-white p-2 rounded-lg border border-slate-200 shadow-sm",children:e.jsx(ce,{value:`IMAM-VALID-${a.digitalSignatureHash}`,size:64})})]}),e.jsxs("div",{className:"border-t border-b border-slate-100 dark:border-slate-800 py-6",children:[e.jsx("h5",{className:"text-xs font-bold text-slate-400 uppercase tracking-widest mb-4",children:"Status Workflow"}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute left-[15px] top-4 bottom-4 w-0.5 bg-slate-100 dark:bg-slate-800 -z-10"}),e.jsx(v,{label:"Pengajuan Masuk",active:!1,completed:!0,date:a.date,actor:a.userName}),e.jsx(v,{label:"Verifikasi Tata Usaha",active:a.status==="Pending",completed:["Verified","Validated","Signed"].includes(a.status),date:a.verifiedAt,actor:a.verifiedBy||(T?"Menunggu Anda":"Staf TU")}),e.jsx(v,{label:"Validasi Pimpinan (Waka)",active:a.status==="Verified",completed:["Validated","Signed"].includes(a.status),date:a.validatedAt,actor:a.validatedBy||(P?"Menunggu Anda":"Waka Bidang")}),e.jsx(v,{label:"Tanda Tangan Kepala",active:a.status==="Validated",completed:a.status==="Signed",date:a.signedAt,actor:a.signedBy||(V?"Menunggu Anda":"Kepala Madrasah")})]})]}),T&&a.status==="Pending"&&e.jsxs("div",{className:"bg-orange-50 dark:bg-orange-900/20 p-4 rounded-xl border border-orange-100 dark:border-orange-800",children:[e.jsxs("h5",{className:"text-xs font-bold text-orange-700 dark:text-orange-400 uppercase mb-3 flex items-center gap-2",children:[e.jsx(re,{className:"w-4 h-4"})," Tindakan Tata Usaha"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("input",{type:"text",value:D,onChange:t=>B(t.target.value),placeholder:"Input Nomor Surat Resmi (Wajib)",className:"w-full bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>k("Verified"),className:"flex-1 bg-orange-600 text-white py-2 rounded-lg text-xs font-bold hover:bg-orange-700",children:"Verifikasi & Teruskan"}),e.jsx("button",{onClick:()=>k("Ditolak"),className:"px-4 bg-red-100 text-red-600 py-2 rounded-lg text-xs font-bold hover:bg-red-200",children:"Tolak"})]})]})]}),P&&a.status==="Verified"&&e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-100 dark:border-blue-800",children:[e.jsxs("h5",{className:"text-xs font-bold text-blue-700 dark:text-blue-400 uppercase mb-3 flex items-center gap-2",children:[e.jsx(W,{className:"w-4 h-4"})," Validasi Teknis"]}),e.jsx("p",{className:"text-xs text-blue-600/80 mb-3",children:"Pastikan isi surat sesuai dengan ketentuan madrasah."}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>k("Validated"),className:"flex-1 bg-blue-600 text-white py-2 rounded-lg text-xs font-bold hover:bg-blue-700",children:"Validasi Surat"}),e.jsx("button",{onClick:()=>k("Ditolak"),className:"px-4 bg-red-100 text-red-600 py-2 rounded-lg text-xs font-bold hover:bg-red-200",children:"Kembalikan"})]})]}),V&&a.status==="Validated"&&e.jsxs("div",{className:"bg-emerald-50 dark:bg-emerald-900/20 p-4 rounded-xl border border-emerald-100 dark:border-emerald-800",children:[e.jsxs("h5",{className:"text-xs font-bold text-emerald-700 dark:text-emerald-400 uppercase mb-3 flex items-center gap-2",children:[e.jsx(le,{className:"w-4 h-4"})," Pengesahan Akhir"]}),e.jsx("p",{className:"text-xs text-emerald-600/80 mb-3",children:"Bubuhkan tanda tangan digital (QR Code) untuk mengesahkan."}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>k("Signed"),className:"flex-1 bg-emerald-600 text-white py-2 rounded-lg text-xs font-bold hover:bg-emerald-700 shadow-lg shadow-emerald-200 dark:shadow-none",children:"Tanda Tangani Digital"}),e.jsx("button",{onClick:()=>k("Ditolak"),className:"px-4 bg-red-100 text-red-600 py-2 rounded-lg text-xs font-bold hover:bg-red-200",children:"Tolak"})]})]}),a.status==="Signed"&&e.jsxs("button",{className:"w-full py-3 bg-indigo-600 text-white rounded-xl font-bold text-sm flex items-center justify-center gap-2 hover:bg-indigo-700 shadow-lg shadow-indigo-200 dark:shadow-none",children:[e.jsx(ne,{className:"w-4 h-4"})," Download Dokumen Sah"]}),a.status==="Ditolak"&&e.jsx("div",{className:"p-4 bg-red-50 text-red-600 rounded-xl text-center text-sm font-bold border border-red-100",children:"Permohonan Ditolak"})]}):null}),e.jsx("div",{className:"p-6 border-t border-slate-100 dark:border-slate-800 flex gap-3 bg-white dark:bg-slate-900 z-10",children:y==="create"?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>b(!1),className:"flex-1 py-3 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-bold rounded-xl text-sm",children:"Batal"}),e.jsx("button",{onClick:z,className:"flex-1 py-3 bg-indigo-600 text-white font-bold rounded-xl text-sm hover:bg-indigo-700",children:"Kirim"})]}):e.jsxs(e.Fragment,{children:[(a==null?void 0:a.status)==="Pending"&&X&&e.jsxs("button",{onClick:()=>Y(a.id),className:"px-4 py-3 bg-red-50 text-red-600 font-bold rounded-xl text-sm flex items-center gap-2 hover:bg-red-100 dark:bg-red-900/20 dark:text-red-400",children:[e.jsx(ie,{className:"w-4 h-4"})," Batalkan"]}),e.jsx("button",{onClick:()=>b(!1),className:"flex-1 py-3 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-bold rounded-xl text-sm hover:bg-slate-200",children:"Tutup"})]})})]})})]})})};export{pe as default};
