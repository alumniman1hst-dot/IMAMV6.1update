import{i as k,d as c,j as e,g as G,U as v,r as d,N as P,a as A,a6 as D,P as C,t as S,c as F}from"./index-CcQVG4nr.js";import{L}from"./Layout-aA6jRwwe.js";import{g as M}from"./studentService-CIZKz8Ta.js";const T="grades",K="subjects",I=[{id:"MTK",name:"Matematika Wajib"},{id:"FIS",name:"Fisika"},{id:"BIO",name:"Biologi"},{id:"KIM",name:"Kimia"},{id:"IND",name:"Bahasa Indonesia"},{id:"ING",name:"Bahasa Inggris"},{id:"PAI",name:"Pendidikan Agama Islam"},{id:"PKN",name:"PKn"},{id:"SJD",name:"Sejarah Indonesia"},{id:"SBD",name:"Seni Budaya"},{id:"PJK",name:"PJOK"},{id:"PKW",name:"Prakarya"}],U=async()=>{if(k)return new Promise(a=>setTimeout(()=>a(I),500));try{if(!c)throw new Error("Database not initialized");const a=await c.collection(K).get();return a.empty?I:a.docs.map(t=>({id:t.id,...t.data()}))}catch(a){return console.warn("Error fetching subjects, using defaults:",a),I}},B=async a=>{if(k)return[];try{if(!c)throw new Error("Database not initialized");return(await c.collection(T).where("subjectId","==",a).get()).docs.map(i=>i.data())}catch(t){return console.error("Error fetching grades:",t),[]}},E=async a=>{if(k)return[{subjectId:"MTK",studentId:a,nilaiHarian:85,nilaiUTS:80,nilaiUAS:90,nilaiAkhir:85},{subjectId:"FIS",studentId:a,nilaiHarian:78,nilaiUTS:82,nilaiUAS:75,nilaiAkhir:78.3},{subjectId:"BIO",studentId:a,nilaiHarian:88,nilaiUTS:85,nilaiUAS:89,nilaiAkhir:87.3}];try{if(!c)throw new Error("Database not initialized");return(await c.collection(T).where("studentId","==",a).get()).docs.map(i=>i.data())}catch(t){return console.error("Error fetching student grades:",t),[]}},H=async a=>{if(k)return console.log("Mock save grade:",a),new Promise(t=>setTimeout(t,300));try{if(!c)throw new Error("Database not initialized");const t=`${a.subjectId}_${a.studentId}`,i=(a.nilaiHarian+a.nilaiUTS+a.nilaiUAS)/3,h={...a,nilaiAkhir:parseFloat(i.toFixed(2))};await c.collection(T).doc(t).set(h,{merge:!0})}catch(t){throw console.error("Error saving grade:",t),t}},O=()=>{const[a,t]=d.useState([]),[i,h]=d.useState(""),[g,N]=d.useState([]),[x,p]=d.useState([]),[j,o]=d.useState(!0),[r,m]=d.useState(!1);d.useEffect(()=>{(async()=>{try{const[n,u]=await Promise.all([U(),M()]);t(n),n.length>0&&h(n[0].id),N(u)}catch{S.error("Gagal memuat data awal.")}finally{o(!1)}})()},[]),d.useEffect(()=>{if(!i||g.length===0)return;(async()=>{o(!0);try{const n=await B(i),u=g.map(l=>n.find(b=>b.studentId===l.id)||{subjectId:i,studentId:l.id||"",nilaiHarian:0,nilaiUTS:0,nilaiUAS:0,nilaiAkhir:0});p(u)}finally{o(!1)}})()},[i,g]);const f=(s,n,u)=>{const l=Math.max(0,Math.min(100,u)),w=[...x],b={...w[s],[n]:l};b.nilaiAkhir=parseFloat(((b.nilaiHarian+b.nilaiUTS+b.nilaiUAS)/3).toFixed(1)),w[s]=b,p(w)},y=async()=>{m(!0);try{await Promise.all(x.map(s=>H(s))),S.success("Semua nilai berhasil disimpan")}catch{S.error("Gagal menyimpan nilai")}finally{m(!1)}};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-white dark:bg-[#151E32] p-5 rounded-2xl border border-slate-100 dark:border-slate-800 shadow-sm",children:[e.jsx("label",{className:"block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 ml-1",children:"Mata Pelajaran"}),e.jsxs("div",{className:"relative",children:[e.jsx("select",{value:i,onChange:s=>h(s.target.value),className:"w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm font-bold text-indigo-600 outline-none appearance-none cursor-pointer",children:a.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))}),e.jsx(P,{className:"absolute right-4 top-3.5 w-4 h-4 text-slate-400 pointer-events-none"})]})]}),e.jsx("div",{className:"bg-white dark:bg-[#151E32] rounded-2xl border border-slate-100 dark:border-slate-800 overflow-hidden shadow-sm",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-left",children:[e.jsx("thead",{className:"bg-slate-50 dark:bg-slate-900/50 text-[8px] font-black text-slate-400 uppercase tracking-widest border-b border-slate-100 dark:border-slate-800",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3",children:"Nama Siswa"}),e.jsx("th",{className:"px-4 py-3 text-center",children:"Harian"}),e.jsx("th",{className:"px-4 py-3 text-center",children:"UTS"}),e.jsx("th",{className:"px-4 py-3 text-center",children:"UAS"}),e.jsx("th",{className:"px-4 py-3 text-center",children:"Akhir"})]})}),e.jsx("tbody",{className:"divide-y divide-slate-50 dark:divide-slate-800",children:j?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"py-20 text-center",children:e.jsx(A,{className:"w-8 h-8 animate-spin mx-auto text-indigo-500"})})}):x.map((s,n)=>{var u;return e.jsxs("tr",{className:"hover:bg-slate-50 transition-colors",children:[e.jsx("td",{className:"px-4 py-3 font-bold text-slate-800 dark:text-white text-[11px] uppercase tracking-tight",children:((u=g.find(l=>l.id===s.studentId))==null?void 0:u.namaLengkap)||"Unknown"}),e.jsx("td",{className:"px-4 py-3 text-center",children:e.jsx("input",{type:"number",value:s.nilaiHarian||"",onChange:l=>f(n,"nilaiHarian",parseFloat(l.target.value)||0),className:"w-12 text-center bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg py-1.5 text-xs font-bold outline-none"})}),e.jsx("td",{className:"px-4 py-3 text-center",children:e.jsx("input",{type:"number",value:s.nilaiUTS||"",onChange:l=>f(n,"nilaiUTS",parseFloat(l.target.value)||0),className:"w-12 text-center bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg py-1.5 text-xs font-bold outline-none"})}),e.jsx("td",{className:"px-4 py-3 text-center",children:e.jsx("input",{type:"number",value:s.nilaiUAS||"",onChange:l=>f(n,"nilaiUAS",parseFloat(l.target.value)||0),className:"w-12 text-center bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg py-1.5 text-xs font-bold outline-none"})}),e.jsx("td",{className:"px-4 py-3 text-center font-black text-indigo-600",children:s.nilaiAkhir.toFixed(0)})]},s.studentId)})})]})})}),e.jsx("div",{className:"flex justify-end pt-2",children:e.jsxs("button",{onClick:y,disabled:r,className:"flex items-center gap-2 bg-indigo-600 text-white px-8 py-3.5 rounded-2xl font-black uppercase text-[10px] tracking-widest shadow-xl active:scale-95 transition-all disabled:opacity-50",children:[r?e.jsx(A,{className:"w-4 h-4 animate-spin"}):e.jsx(D,{className:"w-4 h-4"})," Simpan Nilai"]})})]})},z=()=>{const[a,t]=d.useState([]),[i,h]=d.useState([]),[g,N]=d.useState(!0);return d.useEffect(()=>{(async()=>{var j,o;N(!0);const p=(j=F)==null?void 0:j.currentUser;if(k){const[r,m]=await Promise.all([U(),E("mock-student-id")]);h(r),t(m)}else if(p&&c)try{const r=await c.collection("users").doc(p.uid).get();if(r.exists&&((o=r.data())!=null&&o.studentId)){const m=r.data().studentId,[f,y]=await Promise.all([U(),E(m)]);h(f),t(y)}}catch{S.error("Gagal memuat transkrip nilai.")}N(!1)})()},[]),g?e.jsx("div",{className:"py-20 text-center",children:e.jsx(A,{className:"w-8 h-8 animate-spin mx-auto text-indigo-500"})}):e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"bg-white dark:bg-[#151E32] p-6 rounded-[2rem] border border-slate-100 dark:border-slate-800 shadow-sm relative overflow-hidden",children:[e.jsx("div",{className:"absolute top-0 right-0 p-4 opacity-[0.03]",children:e.jsx(G,{className:"w-32 h-32"})}),e.jsxs("div",{className:"flex justify-between items-center mb-6 relative z-10",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-base font-black text-slate-800 dark:text-white uppercase tracking-tight",children:"Transkrip Nilai"}),e.jsx("p",{className:"text-[9px] font-black text-slate-400 uppercase tracking-widest mt-1",children:"Semester Ganjil 2024/2025"})]}),e.jsx("button",{className:"p-2.5 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 rounded-xl",children:e.jsx(C,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"space-y-2.5 relative z-10",children:a.map((x,p)=>{var r;const j=((r=i.find(m=>m.id===x.subjectId))==null?void 0:r.name)||"Mata Pelajaran",o=x.nilaiAkhir>=75;return e.jsxs("div",{className:"flex items-center justify-between p-3.5 bg-slate-50 dark:bg-slate-900/50 rounded-2xl border border-slate-100 dark:border-slate-800/50",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("h4",{className:"font-bold text-slate-800 dark:text-slate-200 text-xs uppercase truncate pr-4",children:j}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx("span",{className:`text-[8px] font-black uppercase px-1.5 py-0.5 rounded ${o?"text-emerald-600 bg-emerald-50":"text-rose-600 bg-rose-50"}`,children:o?"Tuntas":"Remedial"}),e.jsx("span",{className:"text-[10px] text-slate-400 font-mono",children:"KKM: 75"})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-xl font-black text-slate-900 dark:text-white leading-none",children:x.nilaiAkhir.toFixed(0)}),e.jsx("div",{className:"text-[8px] font-black text-slate-400 uppercase tracking-tighter mt-1",children:"NILAI AKHIR"})]})]},p)})}),e.jsx("div",{className:"mt-6 p-4 bg-indigo-50 dark:bg-indigo-900/20 rounded-2xl border border-dashed border-indigo-200 dark:border-indigo-800 text-center",children:e.jsx("p",{className:"text-[9px] font-black text-indigo-600 dark:text-indigo-400 uppercase tracking-[0.15em] leading-relaxed italic",children:'"Nilai di atas merupakan data realtime dan belum merupakan hasil rapor akhir resmi madrasah."'})})]})})},$=({onBack:a,userRole:t})=>{const i=t===v.GURU||t===v.ADMIN||t===v.STAF_TU;return e.jsx(L,{title:"Nilai & Rapor",subtitle:i?"Manajemen Penilaian":"Hasil Akademik Saya",icon:G,onBack:a,children:e.jsx("div",{className:"p-4 lg:p-6 pb-24",children:i?e.jsx(O,{}):e.jsx(z,{})})})};export{$ as default};
